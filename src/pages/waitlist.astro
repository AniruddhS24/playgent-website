---
import BaseLayout from "../layouts/BaseLayout.astro";
import NavBar from "../components/NavBar.astro";
import Footer from "../components/Footer.astro";
---

<BaseLayout title="Join Waitlist — Playgent">
  <NavBar />
  <main>
    <section class="waitlist-section">
      <div class="waitlist-container">
        <div class="waitlist-content" id="form-container">
          <h1>Join the Waitlist</h1>
          <p class="waitlist-subtitle">Be among the first to test AI agents with confidence.</p>
          
          <form id="waitlist-form" class="waitlist-form">
            <div class="form-group">
              <label for="email">Email *</label>
              <input 
                type="email" 
                id="email" 
                name="email" 
                required 
                placeholder="you@company.com"
              />
            </div>
            
            <div class="form-group">
              <label for="company">Company</label>
              <input 
                type="text" 
                id="company" 
                name="company" 
                placeholder="Acme Corp (optional)"
              />
            </div>
            
            <button type="submit" class="submit-btn" id="submit-btn">
              <span class="btn-text">Join Waitlist</span>
              <span class="btn-loading" style="display:none;">
                <svg class="spinner" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                </svg>
                Submitting...
              </span>
            </button>
            
            <div class="form-message" id="form-message"></div>
          </form>
        </div>

        <!-- Success Message (hidden by default) -->
        <div class="success-container" id="success-container" style="display:none;">
          <div class="success-icon">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="8 12 11 15 16 9"></polyline>
            </svg>
          </div>
          <h1>Thank You!</h1>
          <p class="waitlist-subtitle">We've received your request and will reach out soon.</p>
          <a href="/" class="back-home-btn">Back to Home</a>
        </div>
      </div>
    </section>
  </main>
  <Footer />
</BaseLayout>

<style>
  .waitlist-section {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 120px 32px 80px;
    background: var(--bg);
  }

  .waitlist-container {
    width: 100%;
    max-width: 480px;
    margin: 0 auto;
  }

  .waitlist-content {
    text-align: center;
  }

  .waitlist-content h1 {
    font-size: 48px;
    font-weight: 700;
    margin: 0 0 16px;
    font-family: 'Space Grotesk', sans-serif;
    letter-spacing: -0.02em;
  }

  .waitlist-subtitle {
    font-size: 18px;
    color: var(--muted);
    margin: 0 0 48px;
    line-height: 1.6;
  }

  .waitlist-form {
    display: flex;
    flex-direction: column;
    gap: 24px;
    text-align: left;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .form-group label {
    font-size: 14px;
    font-weight: 600;
    color: var(--fg);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-family: 'Space Grotesk', monospace;
  }

  .form-group input {
    padding: 14px 16px;
    font-size: 16px;
    background: var(--box-bg);
    border: 2px solid var(--border-bright);
    border-radius: 0;
    color: var(--fg);
    font-family: inherit;
    transition: all 0.2s ease;
  }

  .form-group input:focus {
    outline: none;
    border-color: var(--accent);
    background: var(--bg);
  }

  .form-group input::placeholder {
    color: var(--muted);
    opacity: 0.6;
  }

  .submit-btn {
    padding: 16px 32px;
    font-size: 16px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-family: 'Space Grotesk', monospace;
    background: var(--accent);
    color: var(--btn-primary-text);
    border: 2px solid var(--accent);
    border-radius: 0;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 8px;
  }

  .submit-btn:hover:not(:disabled) {
    background: transparent;
    color: var(--accent);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--ring);
  }

  .submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .btn-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .spinner {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .form-message {
    padding: 16px;
    border-radius: 0;
    font-size: 14px;
    font-weight: 600;
    text-align: center;
    display: none;
  }

  .form-message.success {
    display: block;
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
    border: 2px solid #22c55e;
  }

  .form-message.error {
    display: block;
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: 2px solid #ef4444;
  }

  /* Success Container */
  .success-container {
    text-align: center;
    animation: fadeIn 0.5s ease;
  }

  .success-icon {
    margin: 0 auto 32px;
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 3px solid var(--accent);
    border-radius: 50%;
    animation: scaleIn 0.5s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes scaleIn {
    from {
      transform: scale(0);
    }
    to {
      transform: scale(1);
    }
  }

  .back-home-btn {
    display: inline-flex;
    align-items: center;
    padding: 14px 32px;
    margin-top: 24px;
    background: transparent;
    color: var(--accent);
    border: 2px solid var(--accent);
    border-radius: 0;
    font-size: 16px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-family: 'Space Grotesk', monospace;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .back-home-btn:hover {
    background: var(--accent);
    color: var(--btn-primary-text);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--ring);
  }

  @media (max-width: 768px) {
    .waitlist-section {
      padding: 100px 20px 60px;
    }

    .waitlist-content h1 {
      font-size: 36px;
    }

    .waitlist-subtitle {
      font-size: 16px;
      margin-bottom: 32px;
    }
  }
</style>

<script>
  // Load EmailJS
  const loadEmailJS = (): Promise<void> => {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js';
      script.onload = () => resolve();
      script.onerror = () => reject(new Error('Failed to load EmailJS'));
      document.head.appendChild(script);
    });
  };

  const initWaitlistForm = async () => {
    const form = document.getElementById('waitlist-form') as HTMLFormElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const btnText = submitBtn?.querySelector('.btn-text') as HTMLElement;
    const btnLoading = submitBtn?.querySelector('.btn-loading') as HTMLElement;
    const formMessage = document.getElementById('form-message') as HTMLElement;
    const formContainer = document.getElementById('form-container') as HTMLElement;
    const successContainer = document.getElementById('success-container') as HTMLElement;

    if (!form || !submitBtn) return;

    // Load EmailJS
    try {
      await loadEmailJS();
      
      // Get env variables from import.meta.env
      const serviceId = import.meta.env.PUBLIC_EMAILJS_SERVICE_ID;
      const templateId = import.meta.env.PUBLIC_EMAILJS_TEMPLATE_ID;
      const publicKey = import.meta.env.PUBLIC_EMAILJS_PUBLIC_KEY;

      // Console log for debugging
      console.log('EmailJS Configuration:', {
        serviceId: serviceId ? `✓ ${serviceId}` : '✗ Missing',
        templateId: templateId ? `✓ ${templateId}` : '✗ Missing',
        publicKey: publicKey ? `✓ ${publicKey.substring(0, 10)}...` : '✗ Missing'
      });

      if (!serviceId || !templateId || !publicKey) {
        console.error('EmailJS configuration missing. Please set environment variables.');
        console.error('Required env variables: PUBLIC_EMAILJS_SERVICE_ID, PUBLIC_EMAILJS_TEMPLATE_ID, PUBLIC_EMAILJS_PUBLIC_KEY');
        return;
      }

      // Initialize EmailJS
      (window as any).emailjs.init(publicKey);

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        console.log('Form submission started...');
        
        // Disable button and show loading
        submitBtn.disabled = true;
        btnText.style.display = 'none';
        btnLoading.style.display = 'flex';
        formMessage.className = 'form-message';
        formMessage.style.display = 'none';

        try {

          // Send email using EmailJS
          const response = await (window as any).emailjs.sendForm(serviceId, templateId, form);
          
          console.log('EmailJS response:', response);
          
          // Success - Hide form and show thank you message
          if (formContainer && successContainer) {
            formContainer.style.display = 'none';
            successContainer.style.display = 'block';
          }
        } catch (error) {
          // Error
          console.error('EmailJS error:', error);
          formMessage.textContent = 'Something went wrong. Please try again or email us directly at hello@playgent.dev';
          formMessage.className = 'form-message error';
          
          // Re-enable button
          submitBtn.disabled = false;
          btnText.style.display = 'block';
          btnLoading.style.display = 'none';
        }
      });
    } catch (error) {
      console.error('Failed to initialize EmailJS:', error);
      if (formMessage) {
        formMessage.textContent = 'Failed to load form. Please refresh the page.';
        formMessage.className = 'form-message error';
      }
    }
  };

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initWaitlistForm);
  } else {
    initWaitlistForm();
  }

  // Re-initialize after navigation
  document.addEventListener('astro:after-swap', initWaitlistForm);
</script>

