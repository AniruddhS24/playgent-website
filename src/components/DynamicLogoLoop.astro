---
export interface Props {
  logos: Array<{
    domain: string;
    alt: string;
  }>;
  speed?: number;
  direction?: 'left' | 'right';
  logoHeight?: number;
  gap?: number;
  pauseOnHover?: boolean;
}

const { 
  logos, 
  speed = 50, 
  direction = 'left',
  logoHeight = 32,
  gap = 48,
  pauseOnHover = true
} = Astro.props;

const animationDuration = `${logos.length * 3}s`;
const animationDirection = direction === 'left' ? 'normal' : 'reverse';

// Generate logo URLs with light theme as default
const getLogoUrl = (domain: string, theme: string = 'light') => {
  return `https://img.logo.dev/${domain}?token=pk_HfgoA07ZRleCq6GgNyY27g&format=png&theme=${theme}`;
};
---

<div class="logo-loop-container" data-pause-on-hover={pauseOnHover}>
  <div class="logo-loop-track">
    {[...Array(6)].map((_, copyIndex) => (
      <ul class="logo-loop-list" aria-hidden={copyIndex > 0}>
        {logos.map((logo) => (
          <li class="logo-loop-item">
            <img 
              src={getLogoUrl(logo.domain, 'light')} 
              alt={logo.alt} 
              height={logoHeight}
              data-logo-domain={logo.domain}
              class="theme-aware-logo"
            />
          </li>
        ))}
      </ul>
    ))}
  </div>
</div>

<style define:vars={{ animationDuration, animationDirection, logoHeight: `${logoHeight}px`, gap: `${gap}px` }}>
  .logo-loop-container {
    position: relative;
    overflow: hidden;
    width: 100%;
    padding: 20px 0;
  }
  
  .logo-loop-track {
    display: flex;
    width: max-content;
    animation: scroll var(--animationDuration) linear infinite var(--animationDirection);
  }
  
  .logo-loop-container[data-pause-on-hover="true"]:hover .logo-loop-track {
    animation-play-state: paused;
  }
  
  .logo-loop-list {
    display: flex;
    align-items: center;
    list-style: none;
    margin: 0;
    padding: 0;
  }
  
  .logo-loop-item {
    flex-shrink: 0;
    margin-right: var(--gap);
    display: flex;
    align-items: center;
    height: var(--logoHeight);
  }
  
  .logo-loop-item img {
    height: var(--logoHeight);
    width: auto;
    object-fit: contain;
    opacity: 0.8;
    transition: opacity 0.3s ease;
    user-select: none;
    -webkit-user-drag: none;
  }
  
  .logo-loop-item:hover img {
    opacity: 1;
  }
  
  @keyframes scroll {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(calc(-100% / 6));
    }
  }
  
  @media (prefers-reduced-motion: reduce) {
    .logo-loop-track {
      animation: none;
    }
  }
</style>

<script>
  function updateLogosForTheme() {
    const getCurrentTheme = () => {
      return document.documentElement.classList.contains('dark') ? 'dark' : 'light';
    };

    const updateLogoSrcs = () => {
      const theme = getCurrentTheme();
      const logos = document.querySelectorAll('.theme-aware-logo');
      
      logos.forEach((img) => {
        const logoImg = img as HTMLImageElement;
        const domain = logoImg.getAttribute('data-logo-domain');
        if (domain) {
          logoImg.src = `https://img.logo.dev/${domain}?token=pk_HfgoA07ZRleCq6GgNyY27g&format=png&theme=${theme}`;
        }
      });
    };

    // Update on load
    updateLogoSrcs();

    // Listen for theme changes
    const observer = new MutationObserver(() => {
      updateLogoSrcs();
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['class']
    });
  }

  // Run on initial load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', updateLogosForTheme);
  } else {
    updateLogosForTheme();
  }

  // Re-run after page navigation
  document.addEventListener('astro:after-swap', updateLogosForTheme);
</script>

